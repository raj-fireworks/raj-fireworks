<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - AJ Crackers</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
  <meta name="description" content="AJ Crackers - Admin Panel" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>

  <!-- ✅ Firebase compat SDKs for easy use -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <h1>AJ Crackers – Admin Panel</h1>
  <button onclick="logoutAdmin()">Logout</button>
</header>

<section>
  <h2>Add / Update Firework</h2>
  <form id="fireworkForm" onsubmit="event.preventDefault(); addOrUpdateFirework();">
    <input list="fireworkNamesList" id="fireworkName" placeholder="Firework Name" required />
    <input type="number" id="fireworkPrice" placeholder="Price (₹)" min="1" required />
    <button type="submit">Save</button>
  </form>
  <div id="adminMessage"></div>
</section>

<section>
  <h2>Offer Percentage</h2>
  <input type="number" id="offerPercent" min="1" max="99" value="70" />
  <button onclick="saveOffer()">Save Offer</button>
</section>

<section>
  <h2>Fireworks List</h2>
  <table border="1">
    <thead><tr><th>Name</th><th>Price (₹)</th><th>Actions</th></tr></thead>
    <tbody id="fireworkTableBody"></tbody>
  </table>
  <button onclick="exportToExcel()">Download Excel</button>
  <button onclick="downloadProductsJson()">Download JSON</button>
</section>

<script>
  const firebaseConfig = {
    apiKey: "...",
    authDomain: "aj-crackers-16343.firebaseapp.com",
    databaseURL: "https://aj-crackers-16343-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "aj-crackers-16343",
    storageBucket: "aj-crackers-16343.appspot.com",
    messagingSenderId: "541140087323",
    appId: "...",
    measurementId: "G-3DZBHD8SEB"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const ADMIN_PASSWORD = "PRVidhyuth@36";

  function isAdminAuthenticated() {
    return sessionStorage.getItem("isAdminAuthenticated") === "true";
  }

  function promptAdminPassword() {
    const pwd = prompt("Admin password:");
    if (pwd === ADMIN_PASSWORD) {
      sessionStorage.setItem("isAdminAuthenticated", "true");
      return true;
    }
    alert("Incorrect password");
    return false;
  }

  function logoutAdmin() {
    sessionStorage.removeItem("isAdminAuthenticated");
    alert("Logged out");
    location.reload();
  }

  function addOrUpdateFirework() {
    if (!isAdminAuthenticated() && !promptAdminPassword()) return;

    const name = document.getElementById("fireworkName").value.trim();
    const price = parseFloat(document.getElementById("fireworkPrice").value);
    if (!name || isNaN(price) || price <= 0) {
      alert("Enter valid name and price");
      return;
    }

    const ref = db.ref("fireworks/" + encodeURIComponent(name));
    ref.once("value").then(snap => {
      const existing = snap.val();
      return existing && existing != price ?
        confirm(`Update "${name}" from ₹${existing} to ₹${price}?`) ? ref.set(price) : null
        : ref.set(price);
    }).then(() => {
      document.getElementById("adminMessage").textContent = `Saved "${name}" ₹${price}`;
      loadData();
    }).catch(e => alert("Error: " + e.message));
  }

  function saveOffer() {
    const val = parseInt(document.getElementById("offerPercent").value);
    if (!val || val < 1 || val > 99) return alert("Enter 1–99");
    db.ref("offer").set({offer: val, validTill: "2025-07-15"});
    alert(`Offer set at ${val}%`);
  }

  function renderFireworkTable(data = {}) {
    const tbody = document.getElementById("fireworkTableBody");
    tbody.innerHTML = '';
    Object.keys(data).sort().forEach(name => {
      const price = data[name];
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${decodeURIComponent(name)}</td>
        <td>₹${price}</td>
        <td>
          <button onclick="editInline('${name}', ${price})">Edit</button>
          <button onclick="deleteFirework('${name}')">Delete</button>
        </td>`;
      tbody.appendChild(row);
    });
  }

  function loadData() {
    db.ref("fireworks").on("value", snap => renderFireworkTable(snap.val()));
  }

  function editInline(encodedName, price) {
    const rows = document.querySelectorAll(`#fireworkTableBody tr`);
    rows.forEach(r => {
      const cell = r.cells[0];
      if (cell.textContent === decodeURIComponent(encodedName)) {
        cell.innerHTML = `<input id="editName" value="${decodeURIComponent(encodedName)}">`;
        r.cells[1].innerHTML = `<input type="number" id="editPrice" value="${price}">`;
        r.cells[2].innerHTML = `
          <button onclick="saveInline('${encodedName}')">Save</button>
          <button onclick="loadData()">Cancel</button>`;
      }
    });
  }

  function saveInline(origEncName) {
    const newName = encodeURIComponent(document.getElementById("editName").value.trim());
    const newPrice = parseFloat(document.getElementById("editPrice").value);
    if (!newName || isNaN(newPrice) || newPrice <= 0) return alert("Invalid");
    if (newName !== origEncName) db.ref("fireworks/" + origEncName).remove();
    db.ref("fireworks/" + newName).set(newPrice);
    loadData();
  }

  function deleteFirework(name) {
    if (confirm("Delete " + decodeURIComponent(name) + "?")) {
      db.ref("fireworks/" + name).remove();
    }
  }

  function exportToExcel() {
    db.ref("fireworks").once("value").then(snap => {
      const data = snap.val() || {};
      const rows = Object.keys(data).map(n => ({
        "Firework": decodeURIComponent(n), "Price": data[n]
      }));
      if (!rows.length) return alert("Empty list");
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "List");
      XLSX.writeFile(wb, "AJ_Fireworks.xlsx");
    });
  }

  function downloadProductsJson() {
    db.ref("fireworks").once("value").then(snap => {
      const file = new Blob([JSON.stringify(snap.val(), null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.download = "products.json";
      a.href = URL.createObjectURL(file);
      a.click();
    });
  }

  loadData();
</script>

</body>
</html>
