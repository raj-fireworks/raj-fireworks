<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AJ Crackers - Admin Bill Page</title>
  <style>
    body { font-family: sans-serif; padding: 20px; margin: 0; }
    h1 { color: #d9534f; }
    input, textarea { padding: 8px; font-size: 14px; margin-bottom: 10px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background-color: #f9f9f9; text-align: center; }
    td:first-child { text-align: left; }
    .button {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 20px;
      cursor: pointer;
      border-radius: 4px;
    }
    .button:hover { background-color: #d32f2f; }
    .category-header { background-color: #f0f0f0; cursor: pointer; font-weight: bold; text-align: left; }
    .category-header td { padding-left: 15px; font-size: 18px; }
    .category-row { transition: all 0.3s ease; }
    .item-total, th:last-child, td:last-child { text-align: center; }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      justify-content: flex-end;
    }
    .container > div {
      width: 100%;
      max-width: 1200px;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      flex: 1;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    input[type="text"],
    input[type="number"],
    input[type="tel"],
    textarea {
      width: 100%;
      box-sizing: border-box;
    }

    input[type="number"] {
      width: 80px;
    }

    table input[type="number"] {
      width: 60px;
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>

<body onload="initializeAdminPage()">
  <div class="container">
    <div>
      <h1>ðŸ§¾ AJ Crackers â€” Admin Bill Page</h1>

      <div class="form-row">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="customerName" placeholder="Enter customer name">
        </div>
        <div class="form-group">
          <label>Address *</label>
          <textarea id="customerAddress" rows="3" placeholder="Enter address"></textarea>
        </div>
        <div class="form-group">
          <label>Phone (optional)</label>
          <input type="tel" id="customerPhone" placeholder="Enter phone number" maxlength="10"
            onkeypress="return /[0-9]/.test(event.key) && this.value.length < 10">
        </div>
      </div>

      <table id="productTable">
        <thead>
          <tr>
            <th>Crackers Name</th>
            <th>Unit</th>
            <th>Actual Price (Rs.)</th>
            <th>Offer Price (Rs.)</th>
            <th>Quantity</th>
            <th>Total (Rs.)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
<div id="grandTotalContainer" style="margin-top: 20px; font-size: 18px; font-weight: bold; text-align: right;">
  Grand Total: Rs.0.00
</div>

      <button class="button" onclick="printBill()">ðŸ§¾ Print Bill</button>
      <button class="button" style="background-color:#5cb85c; margin-left: 10px;" onclick="printChecklist()">ðŸ“‹ Print Checklist</button>
      <button class="button" style="background-color:#5bc0de; margin-left: 10px;" onclick="downloadCustomerInfo()">ðŸ“¥ Download Customer Info</button>

      <script>
        const { jsPDF } = window.jspdf;
        let currentOffer = 80;

        function initializeAdminPage() {
          loadProducts();
        }

        function loadProducts() {
          fetch('productsadmin.json')
            .then(res => res.json())
            .then(data => {
              const products = Object.entries(data).map(([name, info]) => ({
                name,
                unit: info.unit || '-',
                price: Number(info.price) || 0,
                offerprice: Number(info.offerprice) || 0,
                category: info.category || 'Uncategorized'
              }));
              renderAdminTable(products);
            })
            .catch(err => {
              console.error('Error loading products:', err);
              document.querySelector('#productTable tbody').innerHTML =
                '<tr><td colspan="6">Failed to load products.</td></tr>';
            });
        }

        function renderAdminTable(products) {
          const tbody = document.querySelector('#productTable tbody');
          tbody.innerHTML = '';

          const categories = {};
          products.forEach(p => {
           const key = toTitleCase(p.category.trim() || 'Uncategorized');
            categories[key] = categories[key] || [];
            categories[key].push(p);
          });

          let categoryIndex = 0;

          Object.entries(categories).forEach(([category, items]) => {
            const catId = `cat-${categoryIndex}`;
            const catRow = document.createElement('tr');
            catRow.className = 'category-header';
            catRow.innerHTML = `<td colspan="6" style="cursor:pointer;text-align:left;">â–¼ ${category}</td>`;
            tbody.appendChild(catRow);

            items.forEach(item => {
              const row = document.createElement('tr');
              row.className = `category-row ${catId}`;
              row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.unit}</td>
                <td>Rs.${item.price.toFixed(2)}</td>
                <td>Rs.${item.offerprice.toFixed(2)}</td>
                <td><input type="number" min="0" step="1" placeholder="Qty" onchange="updateTotals()" oninput="validateIntegerInput(this)"
                           data-name="${item.name}" data-price="${item.offerprice}"></td>
                <td class="item-total">Rs.0.00</td>`;
              tbody.appendChild(row);
            });

            catRow.addEventListener('click', () => {
              const rows = document.querySelectorAll(`.${catId}`);
              const isVisible = rows[0]?.style.display !== 'none';
              rows.forEach(r => r.style.display = isVisible ? 'none' : '');
              catRow.cells[0].innerText = `${isVisible ? 'â–¶' : 'â–¼'} ${category}`;
            });

            categoryIndex++;
          });
        }
function toTitleCase(str) {
  return str.replace(/\w\S*/g, function (txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });
}

        function validateIntegerInput(input) {
          if (input.value && !/^\d+$/.test(input.value)) {
            alert('Please enter a whole number.');
            input.value = '';
            input.focus();
          }
        }

       function updateTotals() {
  let grandTotal = 0;

  document.querySelectorAll('#productTable tbody tr').forEach(row => {
    const input = row.querySelector('input[type="number"]');
    const totalCell = row.querySelector('.item-total');
    if (!input) return;

    const qty = parseInt(input.value) || 0;
    const price = parseFloat(input.dataset.price) || 0;
    const total = qty * price;
    grandTotal += total;

    totalCell.textContent = `Rs.${total.toFixed(2)}`;
  });

  // âœ… Update the grand total at the bottom
  document.getElementById('grandTotalContainer').textContent = `Grand Total: Rs.${grandTotal.toFixed(2)}`;
}


        function downloadCustomerInfo() {
          const today = new Date().toISOString().slice(0, 10);
          const name = document.getElementById('customerName').value.trim();
          const address = document.getElementById('customerAddress').value.trim();
          const phone = document.getElementById('customerPhone').value.trim();


          let customers = JSON.parse(localStorage.getItem('customerInfo')) || [];
          customers.push({ date: today, name, address, phone });
          localStorage.setItem('customerInfo', JSON.stringify(customers));

          let content = `Date,Name,Address,Phone\n`;
          customers.forEach(c => {
            const safeDate = `="${c.date}"`;
            const safePhone = c.phone ? `="${c.phone}"` : '';
            const safeName = `"${c.name.replace(/"/g, '""')}"`;
            const safeAddress = `"${c.address.replace(/"/g, '""')}"`;
            content += `${safeDate},${safeName},${safeAddress},${safePhone}\n`;
          });

          const blob = new Blob([content], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `CustomerInfo_${today}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
function printChecklist() {
  const name = document.getElementById('customerName').value.trim();
  const address = document.getElementById('customerAddress').value.trim();
  if (!name || !address) {
    alert('Name and Address are required.');
    return;
  }
  const phone = document.getElementById('customerPhone').value.trim();

  const rows = [];
  let count = 0;

  document.querySelectorAll('#productTable tbody tr').forEach(row => {
    const input = row.querySelector('input[type="number"]');
    if (!input) return;
    const qty = parseInt(input.value) || 0;
    if (qty <= 0) return;
    const pname = input.dataset.name;
    count++;
    rows.push([count, pname, qty]);
  });

  if (!rows.length) {
    alert('Please enter at least one product quantity.');
    return;
  }

  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text('Packing Checklist', 14, 20);
  doc.setFontSize(12);
  doc.text(`Name: ${name}`, 14, 30);
  doc.text(`Address: ${address}`, 14, 38);
  if (phone) doc.text(`Phone: ${phone}`, 14, 46);

  doc.autoTable({
    startY: 55,
    head: [['S.No', 'Product', 'Qty']],
    body: rows,
    theme: 'grid',
    headStyles: { fillColor: [92, 184, 92] }, // green header
  });

  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(10);
  doc.text('Use this checklist for packing the order.', 14, finalY);

  doc.save(`Checklist_${name.replace(/\s+/g, '_')}.pdf`);
}

        function printBill() {
          const name = document.getElementById('customerName').value.trim();
          const address = document.getElementById('customerAddress').value.trim();
          if (!name || !address) {
            alert('Name and Address are required.');
            return;
          }
          const phone = document.getElementById('customerPhone').value.trim();

          const rows = [];
          let count = 0, grandTotal = 0;
          document.querySelectorAll('#productTable tbody tr').forEach(row => {
            const input = row.querySelector('input[type="number"]');
            if (!input) return;
            const qty = parseInt(input.value) || 0;
            if (qty <= 0) return;
            const pname = input.dataset.name;
            const price = parseFloat(input.dataset.price);
            const total = qty * price;
            count++;
            grandTotal += total;
            rows.push([count, pname, qty, `${price.toFixed(2)}`, `${total.toFixed(2)}`]);
          });

          if (!rows.length) {
            alert('Please enter at least one product quantity.');
            return;
          }

          const doc = new jsPDF();
          doc.setFontSize(16);
          doc.text('AJ Crackers - Customer Bill', 14, 20);
          doc.setFontSize(12);
          doc.text(`Name: ${name}`, 14, 30);
          doc.text(`Address: ${address}`, 14, 38);
          if (phone) doc.text(`Phone: ${phone}`, 14, 46);

          doc.autoTable({
            startY: 55,
            head: [['S.No', 'Product', 'Qty', 'Rate', 'Total']],
            body: rows,
            theme: 'grid',
            headStyles: { fillColor: [217, 83, 79] },
          });

          const finalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(13);
          doc.text(`Grand Total (After ${currentOffer}% Discount): ${grandTotal.toFixed(2)}`, 14, finalY);
          doc.setFontSize(10);
          doc.text('Thank you for shopping with AJ Crackers!', 14, finalY + 8);

          doc.save(`Bill_${name.replace(/\s+/g, '_')}.pdf`);
        }
      </script>
    </div>
  </div>
</body>
</html>
