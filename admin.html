<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - AJ Crackers</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
  <meta name="description" content="Aj Crackers - Admin Firework Management" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body>

<header class="site-header">
  <div class="brand-name">
    <span class="raj">AJ</span>
    <span class="crackers">Crackers</span>
    <div class="tagline">Your Trusted Firework Partner</div>
  </div>
  <div class="header-right">
    <button onclick="logoutAdmin()">Logout Admin</button>
    <a href="details.html" title="Back to Billing"><i class="fas fa-arrow-left"></i></a>
  </div>
</header>

<h2>Admin Panel: Add or Update Firework</h2>

<form id="fireworkForm" onsubmit="event.preventDefault(); addOrUpdateFirework();">
  <label for="fireworkName">Firework Name:</label>
  <input list="fireworkNamesList" id="fireworkName" required />
  <datalist id="fireworkNamesList"></datalist>

  <label for="fireworkPrice">Price (₹):</label>
  <input type="number" id="fireworkPrice" min="1" required />

  <div>
    <button type="submit">Add / Update</button>
  </div>
</form>

<div id="adminMessage"></div>

<label for="offerPercent">Offer %:</label>
<input type="number" id="offerPercent" value="70" min="1" max="99" />
<button onclick="saveOffer()">Save Offer</button>

<table id="fireworkTable" border="1">
  <thead>
    <tr>
      <th>Firework Name</th>
      <th>Price (₹)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="fireworkTableBody"></tbody>
</table>

<div>
  <button onclick="exportToExcel()">Download Price List</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBCgufTTErG1FMLCcOoScj6dZlmI8Liq_E",
    authDomain: "aj-crackers-16343.firebaseapp.com",
    databaseURL: "https://aj-crackers-16343-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "aj-crackers-16343",
    storageBucket: "aj-crackers-16343.appspot.com",
    messagingSenderId: "541140087323",
    appId: "1:541140087323:web:f7034f7248b3301f44febe"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const ADMIN_PASSWORD = "PRVidhyuth@36";

  function isAdminAuthenticated() {
    return sessionStorage.getItem("isAdminAuthenticated") === "true";
  }

  function promptAdminPassword() {
    const pwd = prompt("Enter admin password:");
    if (pwd === ADMIN_PASSWORD) {
      sessionStorage.setItem("isAdminAuthenticated", "true");
      return true;
    }
    alert("Incorrect password");
    return false;
  }

  function logoutAdmin() {
    sessionStorage.removeItem("isAdminAuthenticated");
    alert("Logged out");
    location.reload();
  }

  function addOrUpdateFirework() {
    if (!isAdminAuthenticated() && !promptAdminPassword()) return;

    const name = document.getElementById("fireworkName").value.trim();
    const price = parseFloat(document.getElementById("fireworkPrice").value);

    if (!name || isNaN(price)) {
      alert("Valid name and price required.");
      return;
    }

    const fireworkData = {
      price: price,
      updatedBy: "adminKey123"
    };

    db.ref("fireworks/" + name).set(fireworkData)
      .then(() => {
        document.getElementById("adminMessage").textContent = `✅ ${name} set to ₹${price}`;
        document.getElementById("fireworkName").value = "";
        document.getElementById("fireworkPrice").value = "";
      })
      .catch(err => alert("❌ Error: " + err.message));
  }

  function saveOffer() {
    const offer = parseInt(document.getElementById("offerPercent").value);
    if (isNaN(offer) || offer < 1 || offer > 99) {
      alert("Enter valid offer between 1 and 99.");
      return;
    }
    db.ref("offer").set({ offer: offer, updatedBy: "adminKey123" })
      .then(() => alert("✅ Offer updated"))
      .catch(err => alert("❌ " + err.message));
  }

  function renderFireworkTable(data) {
    const tbody = document.getElementById("fireworkTableBody");
    tbody.innerHTML = "";

    const names = Object.keys(data || {});
    if (names.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3">No fireworks added</td></tr>`;
      return;
    }

    names.forEach(name => {
      const price = data[name].price;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${name}</td>
        <td>₹${price}</td>
        <td>
          <button onclick="editInline('${name}', ${price})">Edit</button>
          <button onclick="deleteFirework('${name}')">Delete</button>
        </td>`;
      tbody.appendChild(row);
    });

    // update autocomplete
    const datalist = document.getElementById("fireworkNamesList");
    datalist.innerHTML = "";
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      datalist.appendChild(opt);
    });
  }

  function editInline(name, price) {
    document.getElementById("fireworkName").value = name;
    document.getElementById("fireworkPrice").value = price;
  }

  function deleteFirework(name) {
    if (!confirm(`Delete "${name}"?`)) return;
    db.ref("fireworks/" + name).remove();
  }

  function exportToExcel() {
    db.ref("fireworks").once("value", snapshot => {
      const data = snapshot.val() || {};
      const rows = Object.keys(data).map(name => ({
        "Firework Name": name,
        "Price (₹)": data[name].price
      }));
      const worksheet = XLSX.utils.json_to_sheet(rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Price List");
      XLSX.writeFile(workbook, "AJ_Crackers_Price_List.xlsx");
    });
  }

  function loadData() {
    db.ref("fireworks").on("value", snapshot => {
      const data = snapshot.val() || {};
      renderFireworkTable(data);
    });
  }

  loadData();
</script>

</body>
</html>
